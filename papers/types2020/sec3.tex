\section{Proof theory and proof certificates}

{\color{red} The goal in this section is to say a bit about focusing
  generally, and to give a bit of detail about FPC for Horn clauses.
  Initial draft of text taken from \cite{blanco19ppdp}.
}

\begin{metanote}
  (AM): I would start with the logical reconstruction of \texttt{check}, adding the LJT-style proof terms~c\cite{Herbelin94,LengrandDM06} to fig \ref{fig:augmented} and then reverse engineer what we want/need to say about focusing and FPC. We \textbf{do} not talk about PBT yet, just logic programming (with proof terms). In sec 4 we package \texttt{check} in a PBT query and explain how \texttt{check} works for term generation.
\end{metanote}
\subsection{Focused proof systems}
\label{ssec:focused}

The proof search approach to encoding Horn clause computation
results in the structuring of proofs with repeated
switching between a \emph{goal-reduction} phase and a
\emph{backchaining} phase~\cite{miller91apal}.
%
The notion of \emph{focused proof systems}~\cite{andreoli92jlc,liang09tcs}
generalizes this view of proof construction by identifying the
following two phases. % of proof construction.
\begin{enumerate}
\item The \emph{negative}%
% \footnote{The terminology of negative and positive phases is a bit
%   unfortunate: historically, these terms do not refer to positive or negative
%   subformula occurrences but rather to certain semantic models used in
%   the study of linear logic~\cite{girard87tcs}.}
%
  phase corresponds to  goal-reduction: in this phase,
  inference rules that involve \emph{don't-care-non\-de\-ter\-min\-ism} are
  applied.
%
  As a result, there is no need to consider backtracking over choices
  made in building this phase.

\item The \emph{positive} phase corresponding to  backchaining: in this phase, inference rules that involve
  \emph{don't-know-non\-de\-ter\-min\-ism} are applied: here,
  inference rules need to be supplied with information in order to
  ensure that a completed proof can be built.
%
  That information can be items such as which term is needed to
  instantiate a universally quantified formula and which disjunct of a
  disjunctive goal formula should be proved.
\end{enumerate}
%
Thus, when building a proof tree (in the sequent calculus) from the
conclusion to its leaves, the negative phase corresponds to a simple
computation that needs no external information, while the positive
phase may need such external information to be supplied.
%
In the literature, it is common to refer to a repository of such
external information as either an \emph{oracle} or a \emph{proof
certificate}.



\subsection{Certificate checking with expert predicates}
%\subsection{Adding certificates and experts to a proof system}
\label{ssec:fpc}

\begin{metanote}
  add proof terms and backchaining to sequents and code -- now sig is commented out
\end{metanote}
\begin{footnotesize}
\begin{figure}
\newcommand{\XXi}{{\color{blue}{\Xi}}}
\[
\infer{\XXi\vdash t = t}
      {\eqExpert{\XXi}}
\qquad
\infer{\XXi\vdash \true}
      {\trueExpert{\XXi}}
\qquad
\infer{\XXi\vdash G_1\vee G_2}
      {\XXi'\vdash G_i\qquad \orExpert{\XXi}{\XXi'}{i}}
\qquad
\infer{\XXi\vdash \exists x. G}
      {\XXi'\vdash G[t/x]\qquad \someExpert{\XXi}{\XXi'}{t}}
\]
\vskip -6pt
\[
\infer{\XXi\vdash G_1\wedge G_2}
      {\XXi_1\vdash G_1\quad \XXi_2\vdash G_2\quad \andExpert{\XXi}{\XXi_1}{\XXi_2}}
\qquad
\infer{\XXi\vdash A}
      {\XXi'\vdash G \quad (A~\hbox{\tt :-}~G)\in\instan\Pscr
                     \quad \unfoldExpert{\XXi}{\XXi'}}
\]
\caption{A proof system augmented with proof certificates and
  additional ``expert'' premises.}
\label{fig:augmented}
%\lstinputlisting[linerange={sigs-end}]{code/dep-kernel.sig}
\lstinputlisting[linerange={check-end}]{code/dep-kernel.mod}
\caption{A dependent kernel for Coq terms.}
\label{fig:kernel}
\end{figure}
\end{footnotesize}
Figure~\ref{fig:augmented} contains a simple proof system for Horn
clause provability in which each inference rule is augmented with an
additional premise involving an \emph{expert predicate}, a
certificate $\Xi$, and possibly continuations of certificates ($\Xi'$,
$\Xi_1$, $\Xi_2$) with extracted information from certificates (in the
case of $\vee$ and $\exists$).
%
%
% 
Although this proof system is a focused proof system, the
richness of focusing is not apparent in this simplified 
setting: thus, we drop the adjective ``focused'' from this point forward.

Figure~\ref{fig:kernel} contains the \lP implementation of the
inference rules in Figure~\ref{fig:augmented}: here the infix
turnstile $\vdash$ symbol is replaced by the \lst<i{check} predicate.
%
Notice that it is easy to show that no matter how the expert predicates
are defined, if the goal \lsti{check Cert B} is provable in \lP then
\lsti{B} must be a sound consequence of the program clauses stored in
\dots
% the \lsti{prog} predicate (which provides a natural implementation of
% the premise $(A~\hbox{\tt :-}~G)\in\instan{\Pscr}$.
% AM: not there
% in Figure~\ref{fig:kernel}). 

As we mentioned in the introduction, our notion of proof certificates
 is taken from the general setting of \emph{foundational
  proof certificates}~\cite{chihani17jar}.
%
In our case here, an FPC is a collection of \lP clauses that
provide the remaining details not supplied in Figure~\ref{fig:kernel}:
that is, the exact set of constructors for the \lsti{cert} type as
well as the exact specification of the six expert predicates listed in
that figure.
%
Figure~\ref{fig:resources} displays two such FPCs,
both of which can be used to describe proofs where we bound
the number of occurrences of unfoldings in a proof.
%
For example, the first FPC
provides the experts for treating certificates that are constructed
using the \lsti{qheight} constructor.
%
As is easy to verify, the query \mbox{\lsti{(check (qheight 5) B)}} (for the
encoding \lsti{B} of a goal formula) is provable in \lP using the
clauses in Figures~\ref{fig:kernel} and~\ref{fig:resources} if and
only if the height of that proof is 5 or less.
%
Similarly, the second FPC uses the constructor \lsti{qsize} (with two
integers) and can be used to bound the total number of instances of
unfoldings in a proof.
%
In particular, the query \mbox{\lsti{sigma H\ (check (qsize 5 H) B)}}
% \begin{lstlisting}
% sigma H\ (check (qsize 5 H) B)
% \end{lstlisting}
is provable if and only if the total number of unfoldings of that
proof is 5 or less.

\begin{figure}
\lstinputlisting[linerange={resources-end}]{code/fpcs.sig}
\lstinputlisting[linerange={resources-end}]{code/fpcs.mod}
\caption{Two FPCs that describe proofs that are limited in either
  height or in size.}
\label{fig:resources}
\end{figure}

% Finally, Figure~\ref{fig:max} contains the FPC based on the constructor
% \lsti{max} that is used to record explicitly all information within a
% proof: in particular, all disjunctive choices and all substitution
% instances for existential quantifiers are collected into a binary tree
% structure of type \lsti{max}.
% %
% In this sense, proof certificates built with the \lsti{max}
% constructor are \emph{maximally} explicit.
% %
% Such proof certificates are used, for example, in~\cite{Pair}; it is
% important to note that proof checking with such maximally explicit
% certificates can be done with much simpler proof-checkers than those
% used in logic programming since backtracking search and unification
% are not needed.
%

% \begin{figure}
% \lstinputlisting[linerange={max-end}]{code/fpcs.sig}
% \lstinputlisting[linerange={max-end}]{code/fpcs.mod}
% \caption{The \lsti{max} FPC}
% \label{fig:max}
% \end{figure}

Further, if we view a particular FPC as a means of restricting proofs, it is
possible to build an FPC that \emph{restricts} proofs satisfying two FPCs
simultaneously.
%
% In particular, Figure~\ref{fig:pairing} defines an FPC based on the
% (infix) constructor \lsti{<c>}, which \emph{pairs} two terms of type
% \lsti{cert}.
%
The pairing experts for the certificate \lsti{Cert1 <c> Cert2} simply
request that the corresponding experts also succeed for both
\lsti{Cert1} and \lsti{Cert2} and, in the case of the \lsti{orE} and
\lsti{someE}, also return the same choice and substitution term,
respectively.
%
Thus, the query 
\begin{lstlisting}
?- check ((qheight 4) <c> (qsize 10)) B
\end{lstlisting}
will succeed if there is a proof of \lsti{B} that has a height less
than or equal to 4 while also being of size less than or equal to 10.
%
% A related use of the pairing of two proof certificates is to %use it to
% \emph{distill} or \emph{elaborate} proof certificates. 
% %
% For example, the proof certificate \lsti{(qsize 5 0)} is rather implicit
% since it will match any proof that used unfold exactly 5 times.
% %
% However, the query
% \begin{lstlisting}
% ?- check ((qsize 5 0) <c> (max Max)) B.
% \end{lstlisting}
% will store into the \lP variable \lsti{Max} more complete details of
% any proof that satisfies the \lsti{(qsize 5 0)} constraint.
% %
% In particular, this forms the infrastructure of 
%  an \emph{explanation} tool for attributing ``blame'' for
% the origin of a counterexample; these maximal
% certificates are an appropriate starting point for documenting
% both the counterexample and why it serves as a counterexample.


% \begin{figure}
% \lstinputlisting[linerange={pairing-end}]{code/fpcs.sig}
% \lstinputlisting[linerange={pairing-end}]{code/fpcs.mod}
% \caption{FPC for pairing}
% \label{fig:pairing}
% \end{figure}

Various  additional examples and experiments using the pairing of FPCs
can be found in~\cite{Pair}. Using similar techniques, it is possible to define FPCs that target
specific types for special treatment: for example, when generating
integers, only (user-defined) small integers could be produced.


%%% Local Variables:
%%% mode: latex
%%% TeX-master: "main"
%%% End:
